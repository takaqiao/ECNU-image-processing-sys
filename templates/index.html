<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>å…¨åŠŸèƒ½å›¾åƒå¤„ç†ç³»ç»Ÿ</title>
    <!-- å¼•å…¥æ›´ç°ä»£çš„å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #4a90e2;
        --secondary-color: #50e3c2;
        --bg-color: #f4f7f6;
        --panel-bg: #ffffff;
        --text-color: #333;
        --light-text-color: #777;
        --border-color: #e0e0e0;
        --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      body {
        font-family: "Noto Sans SC", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
        animation: fadeIn 0.8s ease-out;
      }

      h1 {
        font-weight: 700;
        font-size: 2.5rem;
        color: var(--primary-color);
      }

      /* --- å…¨å±€æ§åˆ¶æ  --- */
      .controls-bar {
        background: var(--panel-bg);
        border-radius: 12px;
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 1200px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 2rem;
        animation: fadeIn 1s ease-out 0.2s backwards;
      }

      .control-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        width: 100%;
      }

      /* --- æŒ‰é’®å¼é€‰æ‹© --- */
      .category-buttons,
      .operation-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
      }
      .operation-buttons {
        margin-top: 1rem;
        animation: popIn 0.4s ease-out;
      }

      .control-btn {
        padding: 0.6rem 1.2rem;
        border: 2px solid var(--border-color);
        background-color: transparent;
        color: var(--light-text-color);
        border-radius: 20px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .control-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
      }
      .control-btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      #paramsContainer input[type="number"],
      #paramsContainer input[type="range"] {
        width: 80px;
        padding: 0.8rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        vertical-align: middle;
      }
      #paramsContainer label {
        vertical-align: middle;
      }

      input[type="file"] {
        display: none;
      }
      .file-upload-label {
        padding: 0.8rem 1.5rem;
        background: var(--primary-color);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .file-upload-label:hover {
        opacity: 0.9;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      #processBtn {
        margin-left: auto;
        padding: 0.8rem 2rem;
        font-size: 1rem;
        font-weight: 700;
        color: white;
        background-image: linear-gradient(
          45deg,
          var(--secondary-color),
          var(--primary-color)
        );
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      #processBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .main-container {
        display: flex;
        gap: 2rem;
        width: 100%;
        max-width: 1200px;
        animation: fadeIn 1s ease-out 0.4s backwards;
      }

      .panel {
        flex: 1;
        background: var(--panel-bg);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
      }
      .panel:hover {
        transform: translateY(-5px);
      }

      .image-box {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        width: 100%;
        height: 450px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-color);
        position: relative;
      }

      .image-box .placeholder {
        color: var(--light-text-color);
        font-weight: 500;
      }
      .image-box img {
        max-width: 100%;
        max-height: 100%;
        height: auto;
        width: auto;
        border-radius: 8px;
        display: none;
      }
      .image-box img.visible {
        display: block;
      }

      .loader {
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid var(--primary-color);
        width: 50px;
        height: 50px;
        animation: spin 1.5s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results-box {
        margin-top: 15px;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
        max-height: 400px;
        overflow-y: auto;
      }
      .results-box h4 {
        margin-top: 0;
        color: var(--primary-color);
      }
      .results-box ul {
        padding-left: 20px;
        list-style-type: "ğŸ¨";
      }
      .results-box pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #e9eef2;
        padding: 1rem;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>å…¨åŠŸèƒ½å›¾åƒå¤„ç†ç³»ç»Ÿ</h1>
      <p>ä¸€ä¸ªé›†æˆäº†ç»å…¸ç®—æ³•ä¸ç°ä»£AIçš„å¼ºå¤§å·¥å…·</p>
    </header>

    <!-- å…¨å±€æ§åˆ¶æ  -->
    <div class="controls-bar">
      <div class="control-row">
        <label for="imageLoader" class="file-upload-label">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</label>
        <input type="file" id="imageLoader" accept="image/*" />
        <span id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
        <button id="processBtn">å¤„ç†å›¾åƒ</button>
      </div>
      <div id="operation-panel">
        <div id="category-buttons" class="category-buttons"></div>
        <div id="operation-buttons-container" style="display: none">
          <hr
            style="
              margin: 1.5rem 0;
              border: none;
              border-top: 1px solid var(--border-color);
            "
          />
          <div id="operation-buttons" class="operation-buttons"></div>
        </div>
        <div
          id="paramsContainer"
          style="
            margin-top: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
          "
        ></div>
      </div>
    </div>

    <div class="main-container">
      <!-- è¾“å…¥é¢æ¿ -->
      <div class="panel">
        <h2>è¾“å…¥</h2>
        <div class="image-box">
          <span class="placeholder" id="originalPlaceholder">è¯·ä¸Šä¼ å›¾åƒ</span>
          <img id="originalImage" src="" />
        </div>
      </div>

      <!-- è¾“å‡ºé¢æ¿ -->
      <div class="panel">
        <h2>è¾“å‡º</h2>
        <div class="image-box" id="outputImageBox">
          <div id="loader" class="loader" style="display: none"></div>
          <span class="placeholder" id="processedPlaceholder">ç­‰å¾…å¤„ç†...</span>
          <img id="processedImage" src="" />
        </div>
        <div
          id="outputTextResults"
          class="results-box"
          style="display: none"
        ></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const operationsData = {
          å›¾åƒå˜æ¢: [
            { name: "ç›´æ–¹å›¾å‡è¡¡åŒ–", id: "histogram_equalization" },
            { name: "ç»˜åˆ¶ç›´æ–¹å›¾", id: "plot_histogram" },
            { name: "äºŒå€¼åŒ–", id: "binarize", params: true },
          ],
          å‡ ä½•å˜æ¢: [
            { name: "æ°´å¹³ç¿»è½¬", id: "horizontal_flip" },
            { name: "å‚ç›´ç¿»è½¬", id: "vertical_flip" },
            { name: "å¯¹è§’ç¿»è½¬", id: "cross_flip" },
            { name: "ä»¿å°„å˜æ¢", id: "affine_transform" },
            { name: "ç¼©æ”¾", id: "bilinear_interpolation", params: true },
            { name: "å¹³ç§»", id: "panning", params: true },
            { name: "æ—‹è½¬", id: "rotation", params: true },
          ],
          ç©ºåŸŸæ»¤æ³¢: [
            { name: "ä¸­å€¼æ»¤æ³¢", id: "median_filter", params: true },
            { name: "ç©ºåŸŸé”åŒ–", id: "sharpen" },
          ],
          è¾¹ç¼˜ä¸çº¿æ¡: [
            { name: "Robertsç®—å­", id: "roberts_edge" },
            { name: "Sobelç®—å­", id: "sobel_edge" },
            { name: "Laplacianç®—å­", id: "laplacian_edge" },
            { name: "Cannyç®—å­", id: "canny_edge", params: true },
            { name: "éœå¤«ç›´çº¿æ£€æµ‹", id: "hough_transform" },
          ],
          å½¢æ€å­¦: [
            { name: "è…èš€", id: "erosion", params: true },
            { name: "è†¨èƒ€", id: "dilation", params: true },
            { name: "å¼€è¿ç®—", id: "open_op", params: true },
            { name: "é—­è¿ç®—", id: "close_op", params: true },
          ],
          å™ªå£°æ¨¡æ‹Ÿ: [
            {
              name: "æ·»åŠ æ¤’ç›å™ªå£°",
              id: "add_salt_and_pepper_noise",
              params: true,
            },
            { name: "æ·»åŠ é«˜æ–¯å™ªå£°", id: "add_gaussian_noise" },
          ],
          "é¢‘åŸŸå¤„ç†(é«˜çº§)": [
            { name: "é¢‘åŸŸå¹³æ»‘(ä½é€š)", id: "fft_lowpass", params: true },
            { name: "é¢‘åŸŸé”åŒ–(é«˜é€š)", id: "fft_highpass", params: true },
          ],
          é£æ ¼è¿ç§»: [
            { name: "ç³–æœ", id: "style_candy" },
            { name: "æŠ½è±¡æ²¹ç”»", id: "style_composition_vii" },
            { name: "ç¾½æ¯›", id: "style_feathers" },
            { name: "ç¼ªæ–¯", id: "style_la_muse" },
            { name: "é©¬èµ›å…‹", id: "style_mosaic" },
            { name: "æ˜Ÿå¤œ", id: "style_starry_night" },
            { name: "å‘å–Š", id: "style_the_scream" },
            { name: "æµ·æµª", id: "style_the_wave" },
            { name: "Udnie", id: "style_udnie" },
          ],
          YOLOv8åº”ç”¨å®ç°: [
            { name: "é€šç”¨ç›®æ ‡æ£€æµ‹", id: "yolov8_detect" },
            { name: "PCBç¼ºé™·æ£€æµ‹", id: "pcb_defect_check" },
            { name: "Xå…‰éª¨æŠ˜æ£€æµ‹", id: "bone_fracture_detect" },
          ],
        };

        // --- DOM Elements ---
        const imageLoader = document.getElementById("imageLoader");
        const originalImage = document.getElementById("originalImage");
        const processedImage = document.getElementById("processedImage");
        const categoryButtonsContainer =
          document.getElementById("category-buttons");
        const operationButtonsContainer = document.getElementById(
          "operation-buttons-container"
        );
        const operationButtons = document.getElementById("operation-buttons");
        const paramsContainer = document.getElementById("paramsContainer");
        const processBtn = document.getElementById("processBtn");
        const loader = document.getElementById("loader");
        const outputTextResults = document.getElementById("outputTextResults");
        const fileNameSpan = document.getElementById("fileName");
        const originalPlaceholder = document.getElementById(
          "originalPlaceholder"
        );
        const processedPlaceholder = document.getElementById(
          "processedPlaceholder"
        );

        let originalFile = null;
        let selectedOperationId = null;

        // --- Initialize ---
        function init() {
          for (const category in operationsData) {
            const btn = document.createElement("button");
            btn.className = "control-btn";
            btn.textContent = category;
            btn.dataset.category = category;
            categoryButtonsContainer.appendChild(btn);
            btn.addEventListener("click", handleCategoryClick);
          }
        }

        // --- Event Handlers ---
        function handleCategoryClick(e) {
          const selectedBtn = e.target;
          const category = selectedBtn.dataset.category;

          categoryButtonsContainer
            .querySelectorAll(".control-btn")
            .forEach((b) => b.classList.remove("active"));
          selectedBtn.classList.add("active");

          operationButtons.innerHTML = "";
          paramsContainer.style.display = "none";
          paramsContainer.innerHTML = "";
          selectedOperationId = null;

          operationsData[category].forEach((op) => {
            const opBtn = document.createElement("button");
            opBtn.className = "control-btn";
            opBtn.textContent = op.name;
            opBtn.dataset.id = op.id;
            opBtn.dataset.hasParams = op.params || false;
            operationButtons.appendChild(opBtn);
            opBtn.addEventListener("click", handleOperationClick);
          });

          operationButtonsContainer.style.display = "block";
        }

        function handleOperationClick(e) {
          const selectedBtn = e.target;
          selectedOperationId = selectedBtn.dataset.id;
          const hasParams = selectedBtn.dataset.hasParams === "true";

          operationButtons
            .querySelectorAll(".control-btn")
            .forEach((b) => b.classList.remove("active"));
          selectedBtn.classList.add("active");

          paramsContainer.innerHTML = "";
          if (hasParams) {
            populateParams(selectedOperationId);
            paramsContainer.style.display = "flex";
          } else {
            paramsContainer.style.display = "none";
          }
        }

        function populateParams(opId) {
          const addInput = (name, label, type, value, step, min, max) =>
            `<label for="${name}">${label}:</label><input type="${type}" id="${name}" name="${name}" value="${value}" ${
              step ? `step="${step}"` : ""
            } ${min ? `min="${min}"` : ""} ${max ? `max="${max}"` : ""}>`;
          const addSlider = (name, label, value, min, max, step) =>
            `<label for="${name}">${label}:</label><input type="range" id="${name}" name="${name}" value="${value}" min="${min}" max="${max}" step="${step}"><span id="${name}-value">${value}</span>`;

          let content = "";
          if (opId === "binarize")
            content = addSlider("threshold", "é˜ˆå€¼", 127, 0, 255, 1);
          else if (opId === "median_filter")
            content = addInput("ksize", "æ ¸å¤§å°(å¥‡æ•°)", "number", 5, 2, 3);
          else if (opId === "add_salt_and_pepper_noise")
            content = addSlider("amount", "å™ªå£°æ¯”ä¾‹", 0.04, 0, 0.2, 0.01);
          else if (opId === "fft_lowpass" || opId === "fft_highpass")
            content = addInput("radius", "åŠå¾„", "number", 30, 1);
          else if (opId === "bilinear_interpolation")
            content =
              addInput("fx", "Xç¼©æ”¾", "number", 1.5, 0.1) +
              addInput("fy", "Yç¼©æ”¾", "number", 1.5, 0.1);
          else if (opId === "panning")
            content =
              addInput("dx", "Xå¹³ç§»", "number", 50) +
              addInput("dy", "Yå¹³ç§»", "number", 50);
          else if (opId === "rotation")
            content =
              addInput("angle", "è§’åº¦", "number", 45) +
              addInput("scale", "ç¼©æ”¾", "number", 1.0, 0.1);
          else if (opId === "canny_edge")
            content =
              addInput("thres1", "ä½é˜ˆå€¼", "number", 50) +
              addInput("thres2", "é«˜é˜ˆå€¼", "number", 150);
          else if (
            ["erosion", "dilation", "open_op", "close_op"].includes(opId)
          )
            content = addInput("ksize", "æ ¸å¤§å°", "number", 5, 2, 3);

          paramsContainer.innerHTML = content;

          // Add event listener for sliders to update their value display
          paramsContainer
            .querySelectorAll('input[type="range"]')
            .forEach((slider) => {
              slider.addEventListener("input", (e) => {
                document.getElementById(`${e.target.id}-value`).textContent =
                  e.target.value;
              });
            });
        }

        imageLoader.addEventListener("change", (e) => {
          if (e.target.files && e.target.files[0]) {
            originalFile = e.target.files[0];
            fileNameSpan.textContent = originalFile.name;
            const reader = new FileReader();
            reader.onload = (event) => {
              originalImage.src = event.target.result;
              originalImage.classList.add("visible");
              originalPlaceholder.style.display = "none";
            };
            reader.readAsDataURL(originalFile);
          }
        });

        processBtn.addEventListener("click", () => {
          if (!originalFile || !selectedOperationId) {
            alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡å¹¶é€‰æ‹©ä¸€ä¸ªå…·ä½“æ“ä½œï¼");
            return;
          }

          const formData = new FormData();
          formData.append("image", originalFile);
          formData.append("operation", selectedOperationId);
          paramsContainer
            .querySelectorAll("input")
            .forEach((input) => formData.append(input.name, input.value));

          processedImage.classList.remove("visible");
          processedPlaceholder.style.display = "none";
          outputTextResults.style.display = "none";
          loader.style.display = "block";

          fetch("/api/process", { method: "POST", body: formData })
            .then((response) => {
              if (!response.ok)
                throw new Error(`HTTP error! status: ${response.status}`);
              return response.json();
            })
            .then((data) => {
              if (data.error) throw new Error(data.error);

              if (data.image) {
                processedImage.src = "data:image/jpeg;base64," + data.image;
                processedImage.classList.add("visible");
              } else {
                processedPlaceholder.style.display = "block";
              }
              if (
                data.text ||
                (data.detections && data.detections.length > 0)
              ) {
                let html = "";
                if (data.detections && data.detections.length > 0) {
                  html += `<h4>æ£€æµ‹åˆ° ${data.detections.length} ä¸ªç›®æ ‡:</h4>`;
                  html += "<ul>";
                  data.detections.forEach((d) => {
                    html += `<li><b>${
                      d.class
                    }</b> (ç½®ä¿¡åº¦: ${d.confidence.toFixed(2)})</li>`;
                  });
                  html += "</ul>";
                }
                outputTextResults.innerHTML = html;
                outputTextResults.style.display = "block";
              }
            })
            .catch((error) => {
              alert("å¤„ç†å¤±è´¥: " + error.message);
              processedPlaceholder.textContent = "å¤„ç†å¤±è´¥";
              processedPlaceholder.style.display = "block";
            })
            .finally(() => {
              loader.style.display = "none";
            });
        });

        init();
      });
    </script>
  </body>
</html>
